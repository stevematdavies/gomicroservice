{{template "base" .}}

{{define "content"}}
<div class="container">
    <div class="row">   
        <div class="col">
            <h1 class="mt-5">Test Microservices in <em>Golang&trade;</em></h1>
            <hr>
            <a href="javascript:void(0);" id="brokerBtn" class="btn btn-primary" style="margin-bottom:1em;">Test Broker Service</a>
            <a href="javascript:void(0);" id="authBtn" class="btn btn-primary" style="margin-bottom:1em;">Test Auth Service</a>
            <a href="javascript:void(0);" id="logBtn" class="btn btn-primary" style="margin-bottom:1em;">Test Logger Service</a>
            <div id="output" class="mt5" style="outline: 1px solid silver; padding: 2em;">
                <span class="text-muted">Output shows here...</span>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <h4 class="mt-5">Sent</h4>
            <div class="mt-1" style="outline: 1px solid silver; padding: 2em;">
                <pre id="payload"><span class="text-muted">Nothing sent yet...</span></pre>
            </div>
        </div>
        <div class="col">
            <h4 class="mt-5">Recieved</h4>
            <div class="mt-1" style="outline: 1px solid silver; padding:2em">
                <pre id="recieved"><span class="text-muted">Nothing recieved yet...</span></pre>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "js"}}
    <script>
        const brokerBtn  = document.getElementById("brokerBtn")
        const authBtn    = document.getElementById("authBtn")
        const logBtn    = document.getElementById("logBtn")
        const output     = document.getElementById("output")
        const sent       = document.getElementById("payload")
        const recieved   = document.getElementById("recieved")

        brokerBtn.addEventListener("click", async() => {
            const body = {
                method: 'POST'
            }
            try {
                const request = await fetch("http://localhost:8081",body)
                const data = await request.json()
                sent.innerHTML = "empty post request"
                recieved.innerHTML = JSON.stringify(data, undefined, 4)
                output.innerHTML += `<br><strong>Response from broker service</strong>: <span class="badge bg-success">${data.message}</span>`
            } catch(e) { 
                output.innerHTML +=  `<br><br>Error:  <span class="badge bg-danger">${e}</span>`
            }
        })

        authBtn.addEventListener("click", async() => {

            const headers = new Headers();
            headers.append("Content-Type", "application/json")
          
            const payload = {
                action: "auth",
                auth: {
                    email: "admin@example.com",
                    password: "verysecret"
                }
             }

             const body = {
                method: "POST",
                body: JSON.stringify(payload),
                headers
             }
       
            try {
                const request = await fetch("http://localhost:8081/handle",body)
               
                const data = await request.json()
                sent.innerHTML = JSON.stringify(payload, undefined, 4)
                recieved.innerHTML = JSON.stringify(data, undefined, 4)
                if(data.error){
                    output.innerHTML += `<br><strong>Error: </strong>${data.message}`
                } else {
                      output.innerHTML += `<br><strong>Response from broker service</strong>: <span class="badge bg-success">${data.message}</span>`
                }
            } catch(e) { 
                output.innerHTML +=  `<br><br>Error: <span class="badge bg-danger">${e}</span>`
            }
        })

        logBtn.addEventListener("click", async() => {
            const headers = new Headers();
            headers.append("Content-Type", "application/json")
          
            const payload = {
                action: "log",
                log: {
                    name: "Logger Button Clicked",
                    data: `Button was clicked at: ${new Date().toLocaleTimeString()}`
                }
             }

             const body = {
                method: "POST",
                body: JSON.stringify(payload),
                headers
             }
       
            try {
                const request = await fetch("http://localhost:8081/handle",body)
                const data = await request.json()
                sent.innerHTML = JSON.stringify(payload, undefined, 4)
                recieved.innerHTML = JSON.stringify(data, undefined, 4)
                if(data.error){
                    output.innerHTML += `<br><strong>Error: </strong>${data.message}`
                } else {
                      output.innerHTML += `<br><strong>Response from the logger service</strong>: <span class="badge bg-success">${data.message}</span>`
                }
            } catch(e) { 
                output.innerHTML +=  `<br><br>Error: <span class="badge bg-danger">${e}</span>`
            }
        })
    </script>
{{end}}
